#!/usr/bin/env ruby
#
# rbc - Ruby Command Line Filter
#
# Inspired by https://github.com/thisredone/rb
#

def load_global_config_if_exists
  filespec = File.join(Dir.home, '.rbcrc')
  load(filespec) if File.exists?(filespec)
end


def execute(line_or_enumerator, code)
  puts line_or_enumerator.instance_eval(&code)
rescue Errno::EPIPE
  exit(-13)
end


load_global_config_if_exists
data_mode = ARGV.delete('-l') ? :single_line : :line_enumerator
source_code = "Proc.new { #{ARGV.join(' ')} }"
code = eval(source_code)
data_mode == :single_line ? STDIN.each { |l| execute(l.chomp, code) } : execute(STDIN.each_line, code)

